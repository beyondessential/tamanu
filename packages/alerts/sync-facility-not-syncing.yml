enabled: true
sql: |
  select facility_id from patient_facilities group by facility_id
  except
  select debug_info->>'facilityId' as facility_id from sync_sessions where completed_at > now() - '30 minutes'::interval group by debug_info->>'facilityId';

send:
  - target: zendesk
    endpoint: https://example.zendesk.com/api/v2/requests
    subject: '[Tamanu Alert] No complete sync for at least one facility in the past 30 minutes'
    template: |
      <p>Server: {{ hostname }}</p>
      <p>Alert: {{ filename }}</p>
      <h1>There hasn't been a completed sync session for the following facilit{% if rows | length > 1 %}ies{% else %}y{% endif %} in the past 30 minutes:</h1>
      <ul>
        {% for row in rows %}
        <li><b>{{ row.facility_id }}</b></li>
        {% endfor %}
      </ul>
      <p><b>Report this immediately to support.</b></p>
