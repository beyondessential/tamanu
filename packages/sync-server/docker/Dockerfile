FROM shared as build

RUN yarn workspace sync-server run build

FROM node:12-alpine

ARG NODE_NATIVE_BUILD_DEPS="make gcc g++ python"

WORKDIR /app

# install deps
COPY packages/sync-server/package.json yarn.lock ./
RUN apk add --no-cache --virtual .build-deps $NODE_NATIVE_BUILD_DEPS && \
    yarn install --non-interactive --pure-lockfile --production && \
    yarn cache clean && \
    apk del .build-deps

# copy shared
COPY packages/shared/ node_modules/shared

# copy config
COPY packages/sync-server/config/default.json config/
COPY packages/sync-server/docker/local.json config/

# copy bundle
COPY --from=build /app/packages/sync-server/dist/app.bundle.js dist/

# run config
EXPOSE 3000
CMD ["sh", "-c" , "node dist/app.bundle.js setup; node dist/app.bundle.js serve"]
