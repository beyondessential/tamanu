- name: tamanu does
  type: serial
  encrypted_dockercfg_path: dockercfg.encrypted
  steps:
    - name: copy files
      service: app-without-db
      command: /pre/scripts/copy_files.sh
    - name: install dependencies
      service: app-without-db
      command: scripts/build_shared.sh
    - name: run tests
      type: serial
      steps:
      - name: ensure migrations run cleanly
        service: app-with-db
        command: scripts/apply_and_revert_sync_server_migrations.sh
      - name: hygiene checks (on PR branches)
        type: parallel
        exclude: ^(master$|dev$|staging-|ci-|uat-|uatrispacs-|uatpmi-|beta-|klaus-|sima-|sepi-|da-)
        steps:
          - name: lint desktop app and servers
            service: app-without-db
            command: scripts/lint.sh pr-lints
          #- name: ensure storybook builds
          #  service: app-without-db
          #  command: "yarn workspace desktop run verify-storybook"
          # - TODO(WAITM-215): mobile lints
      - name: test
        type: serial
        steps:
          - name: the desktop app and servers
            service: app-with-db
            type: parallel
            steps:
              - name: on main branches
                command: scripts/test.sh
                tag: ^(master$|dev$|staging-|ci-|uat-|uatrispacs-|uatpmi-)
              - name: on PR branches
                command: scripts/test.sh pr-coverage
                exclude: ^(master$|dev$|staging-|ci-|uat-|uatrispacs-|uatpmi-|beta-|klaus-|sima-|sepi-|da-)
          - name: the mobile app
            service: mobile
            command: 'yarn test:coverage'
            exclude: ^(beta-|klaus-|sima-|sepi-|da-)
    - name: fix ssh for builds
      tag: ^(master$|dev$|staging-|ci-|uat-|uatrispacs-|uatpmi-|beta-|klaus-|sima-|sepi-|da-|deploy-meta$)
      service: app-without-db
      command: /pre/scripts/fix_ssh.sh
    - name: build packages
      tag: ^(master$|dev$|staging-|ci-|uat-|uatrispacs-|uatpmi-|beta-|klaus-|sima-|sepi-|da-|deploy-meta$)
      type: parallel
      steps:
        - name: for lan
          tag: ^(master$|dev$|staging-|ci-|uat-|uatrispacs-|uatpmi-|beta-|klaus-|sima-|sepi-|da-)
          service: app-without-db
          command: ./scripts/build_package_release.sh lan
        - name: for desktop installer
          service: app-without-db
          tag: ^(master$|dev$|staging-|ci-|uat-|uatrispacs-|uatpmi-|beta-|klaus-|sima-|sepi-|da-)
          command: ./scripts/build_desktop.sh build-only
        - name: for sync release
          tag: ^(master$|dev$|staging-|ci-|uat-|uatrispacs-|uatpmi-|beta-|klaus-|sima-|sepi-|da-)
          service: app-without-db
          command: ./scripts/build_package_release.sh sync-server
        - name: for meta release
          tag: ^(master$|dev$|staging-|ci-|uat-|uatrispacs-|uatpmi-|beta-|klaus-|sima-|sepi-|da-|deploy-meta$)
          service: app-without-db
          command: ./scripts/build_package_release.sh meta-server
    - name: push and deploy
      tag: ^(master$|dev$|staging-|ci-|uat-|uatrispacs-|uatpmi-|beta-|release-desktop-|klaus-|sima-|sepi-|da-|deploy-meta$)
      type: parallel
      steps:
        - name: the desktop installer
          service: app-without-db
          tag: ^(release-desktop-)
          command: ./scripts/build_desktop.sh build-and-release
        - name: all artefacts to s3
          service: awsdeployment
          tag: ^(master$|dev$|staging-|ci-|uat-|uatrispacs-|uatpmi-|beta-|klaus-|sima-|sepi-|da-)
          command: ./scripts/push.sh
        # the following serial steps are a fix for a bug where version names can
        # collide if an application is deployed in parallel
        # see https://github.com/codeship-library/aws-utilities/issues/115
        - name: the sync server
          tag: ^(master$|dev$|staging-|ci-|uat-|uatrispacs-|uatpmi-|beta-|klaus-|sima-|sepi-|da-)
          service: awsdeployment
          type: serial
          steps:
            - name: onto dev
              tag: ^(dev$|ci-)
              command: ./scripts/deploy_sync.sh dev tamanu-central-server-dev-16
            - name: onto uat
              tag: ^uat-
              command: ./scripts/deploy_sync.sh uat-fiji-vps tamanu-sync-server-uat-fiji-vps
            - name: onto rispacs uat
              tag: ^uatrispacs-
              command: ./scripts/deploy_sync.sh uatrispacs tamanu-sync-server-uat-rispacs-16
            - name: onto pmi uat
              tag: ^uatpmi-
              command: ./scripts/deploy_sync.sh uatpmi tamanu-central-server-uat-pmi
            - name: onto beta
              tag: ^beta-
              command: ./scripts/deploy_sync.sh beta tamanu-central-server-beta
            - name: onto staging
              tag: ^(staging-)
              command: ./scripts/deploy_sync.sh staging tamanu-central-server-staging-16
            - name: onto demo
              tag: ^(master$)
              command: ./scripts/deploy_sync.sh demo tamanu-sync-server-demo
            - name: onto nauru demo
              tag: ^(master$)
              command: ./scripts/deploy_sync.sh demo-nauru tamanu-sync-server-demo-nauru
            - name: onto palau demo
              tag: ^(master$)
              command: ./scripts/deploy_sync.sh demo-palau tamanu-sync-server-demo-palau
            - name: onto klaus
              tag: ^(klaus-)
              command: ./scripts/deploy_sync.sh klaus tamanu-central-server-klaus
            - name: onto sima
              tag: ^(sima-)
              command: ./scripts/deploy_sync.sh sima tamanu-central-server-sima
            - name: onto sepi
              tag: ^(sepi-)
              command: ./scripts/deploy_sync.sh sepi tamanu-central-server-sepi
            - name: onto da
              tag: ^(da-)
              command: ./scripts/deploy_sync.sh da tamanu-central-server-da
        - name: the lan server
          tag: ^(master$|dev$|staging-|ci-|uat-|uatrispacs-|uatpmi-|beta-|klaus-|sima-|sepi-|da-)
          type: serial
          service: awsdeployment
          steps:
            - name: onto dev A
              tag: ^(dev$|ci-)
              command: ./scripts/deploy_lan.sh dev tamanu-facility-server-dev-16a
            - name: onto dev B
              tag: ^(dev$|ci-)
              command: ./scripts/deploy_lan.sh dev tamanu-facility-server-dev-16b
            - name: onto beta A
              tag: ^(beta-)
              command: ./scripts/deploy_lan.sh beta tamanu-facility-server-beta-a
            - name: onto beta B
              tag: ^(beta-)
              command: ./scripts/deploy_lan.sh beta tamanu-facility-server-beta-b
            - name: onto klaus A
              tag: ^(klaus-)
              command: ./scripts/deploy_lan.sh klaus tamanu-facility-server-klaus-a
            - name: onto klaus B
              tag: ^(klaus-)
              command: ./scripts/deploy_lan.sh klaus tamanu-facility-server-klaus-b
            - name: onto klaus C
              tag: ^(klaus-)
              command: ./scripts/deploy_lan.sh klaus tamanu-facility-server-klaus-c
            - name: onto sima A
              tag: ^(sima-)
              command: ./scripts/deploy_lan.sh sima tamanu-facility-server-sima-a
            - name: onto sepi A
              tag: ^(sepi-)
              command: ./scripts/deploy_lan.sh sepi tamanu-facility-server-sepi-a
            - name: onto da A
              tag: ^(da-)
              command: ./scripts/deploy_lan.sh da tamanu-facility-server-da-a
            - name: onto uat
              tag: ^uat-
              command: ./scripts/deploy_lan.sh uat tamanu-lan-server-uat
            - name: onto rispacs uat
              tag: ^uatrispacs-
              command: ./scripts/deploy_lan.sh uatrispacs tamanu-facility-server-rispacs
            - name: onto pmi uat
              tag: ^uatpmi-
              command: ./scripts/deploy_lan.sh uatpmi tamanu-facility-server-uat-pmi
            - name: onto beta A
              tag: ^(beta-)
              command: ./scripts/deploy_lan.sh beta tamanu-facility-server-beta-a
            - name: onto beta B
              tag: ^(beta-)
              command: ./scripts/deploy_lan.sh beta tamanu-facility-server-beta-b
            - name: onto staging A
              tag: ^(staging-)
              command: ./scripts/deploy_lan.sh staging tamanu-facility-server-staging-16a
            - name: onto staging B
              tag: ^(staging-)
              command: ./scripts/deploy_lan.sh staging tamanu-facility-server-staging-16b
            - name: onto demo
              tag: ^(master$)
              command: ./scripts/deploy_lan.sh demo tamanu-lan-server-demo
            - name: onto nauru demo
              tag: ^(master$)
              command: ./scripts/deploy_lan.sh demo-nauru tamanu-lan-server-demo-nauru
        - name: the meta server
          service: awsdeployment
          type: serial
          steps:
            - name: onto dev
              tag: ^(dev$|ci-)
              command: ./scripts/deploy_meta.sh dev tamanu-meta-server-dev-16
            - name: onto prod
              tag: ^(master|deploy-meta)$
              command: ./scripts/deploy_meta.sh prod tamanu-meta-server-prod-16
