- name: All steps
  type: serial
  encrypted_dockercfg_path: dockercfg.encrypted
  steps:
    - name: copy_files
      service: app
      command: /.tmp/scripts/copy_files.sh
    - name: reinstate_ssh
      service: app
      command: ./scripts/fix_ssh.sh
    - name: install_dependencies
      service: app
      command: ./scripts/install.sh
    - name: build_shared
      service: app
      command: ./scripts/build_shared.sh
    # the build_and_test step runs builds in parallel with tests to speed up codeship
    # don't release anything inside build_and_test! put it in push_and_deploy!
    - name: build_and_test
      type: parallel
      steps:
        - name: test
          service: app
          command: ./scripts/test.sh
        - name: build_and_pack_lan_installer
          service: app
          tag: ^(master$|dev$|staging$|ci-)
          command: ./scripts/build_lan.sh
        - name: build_and_pack_desktop_installer
          service: app
          tag: ^(master$|dev$|staging$|ci-)
          command: ./scripts/build_desktop.sh build-only
        - name: build_sync_release
          tag: ^(master$|dev$|staging$|ci-)
          service: app
          command: ./scripts/build_package_release.sh sync-server
        - name: build_meta_release
          tag: ^(master$|dev$|staging$|ci-)
          service: app
          command: ./scripts/build_package_release.sh meta-server
    - name: push_and_deploy
      type: parallel
      steps:
        - name: build_and_release_desktop_installer
          service: app
          tag: ^(release-desktop-)
          command: ./scripts/build_desktop.sh build-and-release
        - name: push_artefacts_to_s3
          service: awsdeployment
          tag: ^(master$|dev$|staging$|ci-)
          command: ./scripts/push.sh
        # fix for a bug where version names can collide if an application is deployed in parallel
        # see https://github.com/codeship-library/aws-utilities/issues/115
        - name: awscli_name_collision_workaround_sync
          type: serial
          steps:
            - name: deploy_sync_dev_environment
              tag: ^(dev$|ci-)
              service: awsdeployment
              command: ./scripts/deploy_sync_dev.sh
            - name: deploy_sync_staging_environment
              tag: ^(staging$)
              service: awsdeployment
              command: ./scripts/deploy_sync_staging.sh
            - name: deploy_sync_demo_environment
              tag: ^(master$)
              service: awsdeployment
              command: ./scripts/deploy_sync_demo.sh
            - name: deploy_sync_demo_nauru_environment
              tag: ^(master$)
              service: awsdeployment
              command: ./scripts/deploy_sync_demo_nauru.sh
        - name: awscli_name_collision_workaround_meta
          type: serial
          steps:
            - name: deploy_meta_dev_environment
              tag: ^(dev$|ci-)
              service: awsdeployment
              command: ./scripts/deploy_meta_dev.sh
            # meta production environment is deployed from dev so we can quickly add/remove features
            # TODO: revist whether this is a good idea at some later date
            - name: deploy_meta_prod_environment
              tag: ^(dev$)
              service: awsdeployment
              command: ./scripts/deploy_meta_prod.sh
