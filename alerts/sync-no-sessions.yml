sql: |
  SELECT facility_id, last_successful_sync FROM (
    SELECT parameters->'facilityIds'->>0 as facility_id, max(completed_at) as last_successful_sync
    FROM sync_sessions
    WHERE errors IS NULL
    GROUP BY parameters->'facilityIds'->>0
  ) AS last_successful_facility_syncs
  WHERE last_successful_sync < now() - interval '1 hour'

send:
  - target: external
    id: default
    subject: '[Tamanu Alert] No sync sessions created in the last hour ({{ hostname }})'
    template: |
      - Server: {{ hostname }}
      - Alert: {{ filename }}

      **Report this immediately to support.**

      No sync sessions have been created in the last hour.

      This could indicate:
      - Sync service is down or not running
      - Network connectivity issues
      - Database connection problems
      - All facilities are offline

      **Facilities with no recent sync sessions:**
      {% for row in rows %}
      - Facility ID: {{ row.facility_id }} - Last sync: {{ row.last_successful_sync if row.last_successful_sync else 'Unknown' }}
      {% endfor %}

      **Immediate action required:**
      1. Check if sync service is running
      2. Verify database connectivity
      3. Check facility network status
      4. Review system logs for errors
