sql: |
  SELECT
    id,
    errors::text,
    json_array_elements_text(debug_info->'facilityIds') AS facility_id,
    created_at::text AS created,
    (completed_at - created_at)::text AS duration
  FROM sync_sessions
  WHERE
    updated_at > now() - interval '1 minute' -- Lookback window
  AND errors IS NOT NULL
  AND errors <> ARRAY['could not serialize access due to concurrent update'];

send:
  - target: external
    id: default
    subject: '[Tamanu Alert] Sync session error ({{ hostname }})'
    template: |
      <p>Server: {{ hostname }}</p>
      <p>Alert: {{ filename }}</p>
      <h1>Sync sessions with an error in the last minute</h1>
      <p><b>Report this immediately to support.</b></p>
      <ul>
        {% for row in rows | slice(end=5) %}
        <li><b>{{ row.id }}</b>: <i>{{ row.errors }}</i> ({{ row.facility_id }},  duration {{ row.duration }}, start {{ row.created }})</li>
        {% endfor %}
        {% if rows | length > 5 %}
        <li>... and {{ rows | length - 5 }} more</li>
        {% endif %}
      </ul>
      <p>For more information, please check the logs.</p>
