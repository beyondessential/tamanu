name: Diff Translations

on:
  # Test this
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - edited

  workflow_dispatch:

env:
  NODE_MODULES_PATHS: |
    node_modules
    packages/*/node_modules
    !packages/mobile/node_modules
jobs:
  run:
    name: Diff Translations
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
    # - if: (!startsWith(github.ref, 'refs/heads/release/'))
    #   run: |
    #     echo "This workflow can only be run on a release branch"
    #     exit 1
    - uses: actions/checkout@v4
      with:
        # token: ${{ secrets.TAMANU_RELEASE_PAT }}
        # fetch-depth: 0 # fetch all history so we can generate release notes
        fetch-tags: true

    - uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: yarn
    - uses: actions/cache/restore@v3
      with:
        key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
        path: ${{ env.NODE_MODULES_PATHS }}

    - name: install lodash in constants package
      working-directory: packages/constants
      run: yarn

    - name: install ripgrep
      # Had to install manually due to pcre2 not being enabled in apt-get
      run: |
       curl -LO https://github.com/BurntSushi/ripgrep/releases/download/14.1.0/ripgrep_14.1.0-1_amd64.deb
       sudo dpkg -i ripgrep_14.1.0-1_amd64.deb
       echo $(rg --version)


    - name: get current version
      id: currentv
      run: |
        version=$(jq -r .version package.json)
        echo "current_version=$version" >> $GITHUB_OUTPUT

    - name: get closest previous version
      id: previousv
      run: |
        set -euxo pipefail
        git fetch --tags
        git tag --list \
          | grep -E '^v[0-9]+[.][0-9]+[.][0-9]+$' \
          | cut -c2- \
          | sort --version-sort \
          | grep -B 1 "2.3.18" \
          | head -n 1 \
          | sed 's/^/previous_version=/' \
          | tee -a $GITHUB_OUTPUT

    - name: get this versions translations
      run: |
        set -euxo pipefail
        translations=$(.github/scripts/scrape-translations.sh)
        exit_code=$?
        if [ $exit_code -eq 0 ]; then
         echo "$translations" > current-translations.csv
        else
          echo "Scrape translations script failed with exit code $exit_code."
        fi

    - name: test
      run: |
        echo "current_version=${{ steps.currentv.outputs.current_version }}"
        echo "previous_version=${{ steps.previousv.outputs.previous_version }}"
        cat current-translations.csv

    # - name: Upload translations
    #   id: translations-upload
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: translations-${{ steps.currentv.outputs.current_version }}
    #     if-no-files-found: warn
    #     path: current-translations.csv
    #     retention-days: 7

    # - name: exit if no upload
    #   if: steps.translations-upload.outputs.artifact_size == 0
    #   run: |
    #     echo "No translations to diff"
    #     exit 0

    # - name: Configure AWS Credentials (upload)
    #   uses: aws-actions/configure-aws-credentials@v4
    #   with:
    #     aws-region: ap-southeast-2
    #     role-to-assume: arn:aws:iam::143295493206:role/gha-desktop-s3
    #     role-session-name: GHA@Tamanu=DiffTranslations

    # - name: Upload translations to S3
    #   env:
    #     cversion: ${{ steps.currentv.outputs.current_version }}
    #   run: |
    #     aws s3 --no-progress cp current-translations.csv s3://bes-tamanu-translations/$cversion.csv

    # - name: Download previous versions translations from s3
    #   env:
    #     pversion: ${{ steps.previousv.outputs.previous_version }}
    #   run: |
    #     aws s3 --no-progress cp s3://bes-tamanu-translations/$pversion.csv previous-translations.csv

    # - name: Create empty csv if no previous translations
    #   if:
    #   run: |
    #     if [ ! -f previous-translations.csv ]; then
    #       echo "stringId,fallback" > previsous-translations.csv
    #     fi

    # - name: Diff translations
    #   run: |
    #     git diff --no-index previous-translations.csv current-translations.csv > translations.diff

    # - name: Post to release notes somehow
    #   run:
