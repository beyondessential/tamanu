name: CD

on:
  # PRs build all the time, and deploy on demand
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - edited

  # Special issues can opt-in PR-less branches to build and deploy
  issues:
    types:
      - opened
      - edited
      - labeled

  push:
    # Release tags build the server/web packages only
    tags: ['v*.*.*']
    # All branches can potentially be controlled by special issues
    branches: ['*']

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.event.issue.id || github.ref }}
  cancel-in-progress: false

permissions:
  contents: read # to checkout the repo
  packages: write # to pull and push images
  pull-requests: write # to parse PRs for config and update status
  issues: read # to parse special deploy issues
  id-token: write #Â OIDC token for AWS (only for release tags)

jobs:
  config:
    name: Workflow config
    runs-on: ubuntu-latest
    outputs:
      ref: ${{ steps.ref.outputs.result }}
      sha: ${{ steps.sha.outputs.sha }}
      up: ${{ steps.config.outputs.up }}
      down: ${{ steps.config.outputs.down }}
      go-up: ${{ steps.config.outputs.go-up }}
      go-down: ${{ steps.config.outputs.go-down }}
      build-images: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) || steps.control.outputs.build == 'true' || false }}
    steps:
      - uses: actions/checkout@v4
      - name: Figure branch ref and sha
        id: ref
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const cwd = '${{ github.workspace }}';
            const { parseBranchConfig } = await import(`${cwd}/packages/scripts/src/pr-cd.mjs`);
            const ref = parseBranchConfig(context);
            console.log(ref);
            return ref;

      - name: Checkout the real ref
        if: steps.ref.outputs.result != ''
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.ref.outputs.result }}
      - name: Find the real sha
        if: steps.ref.outputs.result != ''
        id: sha
        run: echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Find the control PR/issue body text
        id: control
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const cwd = '${{ github.workspace }}';
            const { findControlText } = await import(`${cwd}/packages/scripts/src/pr-cd.mjs`);
            const issue = await findControlText(context, github);
            console.log(issue);
            if (issue != '') core.setOutput('build', 'true');
            return JSON.stringify(issue);

      - name: Parse deploy config
        if: steps.ref.outputs.result != ''
        id: config
        uses: actions/github-script@v7
        env:
          REF: ${{ steps.ref.outputs.result }}
        with:
          script: |
            const cwd = '${{ github.workspace }}';
            const { parseDeployConfig } = await import(`${cwd}/packages/scripts/src/pr-cd.mjs`);

            const allDeploys = parseDeployConfig({
              body: ${{ steps.control.outputs.result }},
              ref: process.env.REF,
            });
            console.log(allDeploys);

            const matrix = ({ name, options }) => ({ name, options: JSON.stringify(options) });
            const up = allDeploys.filter(deploy => deploy.enabled && !deploy.options.pause).map(matrix);
            const down = allDeploys.filter(deploy => !deploy.enabled && !deploy.options.pause).map(matrix);
            console.log('Going UP', up.length);
            console.log('Going DOWN', down.length);

            core.setOutput('up', JSON.stringify(up));
            core.setOutput('down', JSON.stringify(down));
            core.setOutput('go-up', !!up.length);
            core.setOutput('go-down', !!down.length);

  check-images-exist:
    needs: config
    if: needs.config.outputs.build-images
    name: Check if image was already built
    runs-on: ubuntu-latest
    steps:
      - id: check
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $ --password-stdin
          for repo in central facility frontend meta; do
            if skopeo inspect docker://ghcr.io/beyondessential/tamanu-$repo:sha-${{ needs.branch-config.outputs.sha }} 2>&1 >/dev/null; then
              jq -c . <<< "$desc"
              echo $repo image found, assuming existence
              echo exists=yes | tee -a $GITHUB_OUTPUT
              exit
            else
              echo $repo image not found
            fi
          done
          echo exists=no | tee -a $GITHUB_OUTPUT
    outputs:
      exists: ${{ steps.check.outputs.exists }}

  images:
    needs: [config, check-images-exist]
    if: needs.check-images-exist.outputs.exists != 'yes'
    strategy:
      fail-fast: false
      matrix:
        platform:
          - arch: amd64
            runs-on: ubuntu-latest
          - arch: arm64
            runs-on: Linux-ARM64
        package:
          - name: central
            path: central-server
            target: server
          - name: facility
            path: facility-server
            target: server
          - name: frontend
            path: web
            target: frontend
          - name: meta
            path: meta-server
            target: server

    name: Image for ${{ matrix.package.name }} on ${{ matrix.platform.arch }}
    runs-on: ${{ matrix.platform.runs-on }}

    steps:
      - name: Install docker (arm64 beta)
        if: matrix.platform.arch == 'arm64'
        run: |
          sudo apt-get update
          sudo apt-get install -y ca-certificates curl acl
          sudo install -m 0755 -d /etc/apt/keyrings
          sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
          sudo chmod a+r /etc/apt/keyrings/docker.asc

          echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
            $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
            sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt-get update

          sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
          sudo usermod -aG docker $USER
          sudo setfacl --modify user:$USER:rw /var/run/docker.sock

      - name: Verify docker works
        run: docker run hello-world

      - name: Login to ghcr.io
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $ --password-stdin

      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.config.outputs.ref }}

      - name: Extract version
        id: version
        run: echo "version=$(jq -r .version package.json)" >> "$GITHUB_OUTPUT"

      - name: Setup buildkit
        uses: docker/setup-buildx-action@v3

      - uses: docker/metadata-action@v5
        id: meta
        with:
          labels: |
            org.opencontainers.image.vendor=BES
            org.opencontainers.image.title=Tamanu ${{ matrix.package.name }}
            org.opencontainers.image.url=https://www.bes.au/products/tamanu/
            org.opencontainers.image.source=https://github.com/beyondessential/tamanu/
            org.opencontainers.image.version=${{ steps.version.outputs.version }}
            org.opencontainers.image.licenses=GPL-3.0-or-later

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/${{ matrix.platform.arch }}
          cache-from: type=gha,scope=${{ matrix.platform.arch }}-${{ needs.config.outputs.ref }}-${{ matrix.package.name }}
          cache-to: type=gha,mode=max,scope=${{ matrix.platform.arch }}-${{ needs.config.outputs.ref }}-${{ matrix.package.name }}
          build-args: PACKAGE_PATH=${{ matrix.package.path }}
          target: ${{ matrix.package.target }}
          push: true
          labels: ${{ steps.meta.outputs.labels }}
          tags: ghcr.io/beyondessential/tamanu-${{ matrix.package.name }}:sha-${{ needs.config.outputs.sha }}.${{ matrix.platform.arch }}

  multi-arch:
    needs: [config, images]
    strategy:
      fail-fast: false
      matrix:
        repo:
          - central
          - facility
          - frontend
          - meta

    runs-on: ubuntu-latest
    name: Multi-arch for ${{ matrix.repo }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-manifest-tool

      - name: Combine images
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $ --password-stdin
          manifest-tool push from-args \
            --platforms linux/amd64,linux/arm64 \
            --template ghcr.io/beyondessential/tamanu-${{ matrix.repo }}:sha-${{ needs.config.outputs.sha }}.ARCH \
            --target ghcr.io/beyondessential/tamanu-${{ matrix.repo }}:sha-${{ needs.config.outputs.sha }}

  all-built:
    if: always() # always run even if dependencies fail
    name: All images built
    needs:
      - config
      - check-images-exist
      - images
      - multi-arch
    runs-on: ubuntu-latest
    steps:
      - if: needs.config.outputs.build-images != true
        run: "true" # workflow shouldn't run, fail fast silently
      - if: needs.check-images-exist.outputs.exists == 'yes'
        run: "true" # images exist, nothing to check
      - if: needs.check-images-exist.outputs.exists != 'yes'
        uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}

  deploy-up:
    needs:
      - config
      - all-built
    if: always() && needs.all-built.result == 'success' && fromJson(needs.config.outputs.go-up)
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.config.outputs.up) }}
    name: Deploy ${{ matrix.name }}
    uses: ./.github/workflows/cd-up.yml
    with:
      deploy-name: ${{ matrix.name }}
      options: ${{ matrix.options }}
      image-tag: sha-${{ needs.config.outputs.sha }}
    secrets:
      PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
      TAILSCALE_DBPROXY_ACCESS_OAUTH: ${{ secrets.TAILSCALE_DBPROXY_ACCESS_OAUTH }}
      TAMANU_OPS_SSH: ${{ secrets.TAMANU_OPS_SSH }}

  deploy-down:
    needs: config
    if: fromJson(needs.config.outputs.go-down)
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.config.outputs.down) }}
    name: Undeploy ${{ matrix.name }}
    uses: ./.github/workflows/cd-down.yml
    with:
      deploy-name: ${{ matrix.name }}
      options: ${{ matrix.options }}
    secrets:
      PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
      TAILSCALE_DBPROXY_ACCESS_OAUTH: ${{ secrets.TAILSCALE_DBPROXY_ACCESS_OAUTH }}
      TAMANU_OPS_SSH: ${{ secrets.TAMANU_OPS_SSH }}

  # The package-* jobs below are only triggered by tags, so we can assume that
  # github.ref and github.ref_name are set and correct.

  package-frontend:
    needs: images
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    name: Package Frontend v${{ github.ref_name }}
    uses: ./.github/workflows/cd-package-frontend.yml

  package-servers:
    needs: images
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    name: Package Servers v${{ github.ref_name }}
    uses: ./.github/workflows/cd-package-servers.yml
