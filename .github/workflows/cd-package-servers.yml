name: CD Package Servers

on:
  workflow_call:

permissions:
  contents: read
  id-token: write #Â OIDC token for AWS

jobs:
  linux:
    strategy:
      fail-fast: false
      matrix:
        package:
          - central
          - facility

    name: Pack ${{ matrix.package }} for Linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials (image)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-southeast-2
          role-to-assume: arn:aws:iam::143295493206:role/gha-image-pull
          role-session-name: GHA@Tamanu=WebPackage

      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Pull image
        run: docker pull ${{ steps.login-ecr.outputs.registry }}/tamanu/${{ matrix.package }}:sha-${{ github.sha }}.amd64

      - name: Extract version from image
        id: version
        run: |
          docker image inspect ${{ steps.login-ecr.outputs.registry }}/tamanu/${{ matrix.package }}:sha-${{ github.sha }}.amd64 \
            | jq '"version=\(.[0] | .Config.Labels["org.opencontainers.image.version"])"' -r | tee -a "$GITHUB_OUTPUT"

      - name: Extract files from image
        run: |
          set -x
          docker create --name working ${{ steps.login-ecr.outputs.registry }}/tamanu/${{ matrix.package }}:sha-${{ github.sha }}.amd64
          docker cp working:/app release-v${{ steps.version.outputs.version }}
          docker rm working

      # This will replace the line "cwd: '.'" for the appropriate package, i.e.
      # "cwd: 'packages/facility-server'" in the new build folder for each pm2.config file.
      - name: Prepare production configuration
        run: |
          set -x
          sed -E \
            "s|cwd: '.',( //.*)?|cwd: 'packages/${{ matrix.package }}-server',|" \
            packages/${{ matrix.package }}-server/pm2.config.cjs \
          > release-v${{ steps.version.outputs.version }}/pm2.config.cjs

      - name: Prepare artifact output
        run: |
          set -x

          # for upload to S3
          tar -cf \
            '${{ matrix.package }}-${{ steps.version.outputs.version }}-linux-amd64.tar' \
            'release-v${{ steps.version.outputs.version }}'
          zstd --rm --adapt -T0 -10 \
            '${{ matrix.package }}-${{ steps.version.outputs.version }}-linux-amd64.tar'

          # for the windows pack
          pushd 'release-v${{ steps.version.outputs.version }}'
          rm -rfv node_modules packages/*/node_modules
          popd
          zip -r \
            'release-v${{ steps.version.outputs.version }}.zip' \
            'release-v${{ steps.version.outputs.version }}'

      - name: Upload artifact for next step
        uses: actions/upload-artifact@v4
        with:
          name: winjob-${{ matrix.package }}-${{ steps.version.outputs.version }}
          path: release-v${{ steps.version.outputs.version }}.zip
          retention-days: 1
          if-no-files-found: error
          compression-level: 0

      - name: Upload final output
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.package }}-${{ steps.version.outputs.version }}
          path: '*.tar.zst*'
          retention-days: 15
          if-no-files-found: error
          compression-level: 0

      - name: Configure AWS Credentials (upload)
        if: github.event_name != 'workflow_dispatch'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-southeast-2
          role-to-assume: arn:aws:iam::143295493206:role/gha-server-s3
          role-session-name: GHA@Tamanu=ServerPackage

      - name: Push to S3
        if: github.event_name != 'workflow_dispatch'
        run: |
          set -exu
          for file in *.tar.zst*; do
            aws s3 cp $file s3://bes-tamanu-release-servers/${{ steps.version.outputs.version }}/$file --no-progress
          done
    outputs:
      version: ${{ steps.version.outputs.version }}

  windows:
    needs: linux
    strategy:
      fail-fast: false
      matrix:
        package:
          - central
          - facility

    name: Pack ${{ matrix.package }} for Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: yarn

      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: winjob-${{ matrix.package }}-${{ needs.linux.outputs.version }}

      - name: Unzip artifact for deployment
        shell: bash
        run: |
          ls -R
          unzip release-v${{ needs.linux.outputs.version }}.zip

      - name: Reinstall dependencies
        working-directory: release-v${{ needs.linux.outputs.version }}
        shell: bash
        run: |
          yarn config set network-timeout 600000 -g
          yarn install --frozen-lockfile --production

      - name: Prepare final output
        shell: bash
        run: |
          set -x
          tar -cf \
            '${{ matrix.package }}-${{ needs.linux.outputs.version }}-windows.tar' \
            'release-v${{ needs.linux.outputs.version }}'
          zstd --rm --adapt -T0 -10 '${{ matrix.package }}-${{ needs.linux.outputs.version }}-windows.tar'

      - name: Upload final build
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.package }}-${{ needs.linux.outputs.version }}-windows
          path: '*.tar.zst*'
          retention-days: 15
          if-no-files-found: error
          compression-level: 0

      - name: Configure AWS Credentials (upload)
        if: github.event_name != 'workflow_dispatch'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-southeast-2
          role-to-assume: arn:aws:iam::143295493206:role/gha-server-s3
          role-session-name: GHA@Tamanu=ServerPackage

      - name: Push to S3
        if: github.event_name != 'workflow_dispatch'
        shell: bash
        run: |
          set -x
          for file in *.tar.zst*; do
            aws s3 cp $file s3://bes-tamanu-release-servers/${{ needs.linux.outputs.version }}/$file --no-progress
          done
