name: CD Package Alerts

on:
  workflow_call:

permissions:
  contents: write # to update the release
  id-token: write #Â OIDC token for AWS

jobs:
  alerts:
    name: Pack alert definitions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Package
        run: |
          set -x
          tar -cf 'alerts-${{ steps.version.outputs.version }}.tar' alerts
          zstd --rm --adapt -T0 -10 'alerts-${{ steps.version.outputs.version }}.tar'

      - name: Upload final output
        uses: actions/upload-artifact@v4
        with:
          name: alerts-${{ steps.version.outputs.version }}
          path: 'alerts-*.tar.zst*'
          retention-days: 15
          if-no-files-found: error
          compression-level: 0

      - name: Configure AWS Credentials (upload)
        if: github.event_name != 'workflow_dispatch'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-southeast-2
          role-to-assume: arn:aws:iam::143295493206:role/gha-server-s3
          role-session-name: GHA@Tamanu=AlertsPackage

      - name: Push to S3
        if: github.event_name != 'workflow_dispatch'
        run: |
          set -exu
          for file in alerts-*.tar.zst*; do
            aws s3 cp $file s3://bes-tamanu-release-servers/${{ steps.version.outputs.version }}/$file --no-progress
          done

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: 'alerts-*.tar.zst*'
