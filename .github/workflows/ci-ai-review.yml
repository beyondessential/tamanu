name: Review Hero

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ai-review-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  check-trigger:
    if: >-
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/review-hero')
    runs-on: ubuntu-slim
    outputs:
      pr_number: ${{ steps.pr.outputs.number }}
      head_sha: ${{ steps.pr.outputs.head_sha }}
      pr_title: ${{ steps.pr.outputs.title }}
    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            core.setOutput('number', pr.data.number);
            core.setOutput('head_sha', pr.data.head.sha);
            core.setOutput('title', pr.data.title);
      - name: React to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket',
            });

  review-agent:
    needs: check-trigger
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        agent:
          - key: bugs
            prompt: bugs.md
          - key: performance
            prompt: performance.md
          - key: design
            prompt: design.md
          - key: bes
            prompt: bes-requirements.md
          - key: security
            prompt: security.md
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ needs.check-trigger.outputs.head_sha }}
      - uses: actions/setup-node@v6
        with:
          node-version-file: '.node-version'
      - name: Install Claude CLI
        run: npm install -g @anthropic-ai/claude-code
      - name: Get PR diff
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr diff ${{ needs.check-trigger.outputs.pr_number }} > /tmp/pr.diff
      - name: Run ${{ matrix.agent.key }} agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PR_TITLE: ${{ needs.check-trigger.outputs.pr_title }}
        run: |
          cat .github/scripts/ai-review/agent-prompt.md \
              .github/scripts/ai-review/prompts/${{ matrix.agent.prompt }} \
              <(echo -e "\n\n## PR Title\n\n$PR_TITLE\n\n## PR Diff\n\n\`\`\`diff") \
              /tmp/pr.diff \
              <(echo '```') \
            | claude -p \
              --output-format json \
              --model "${{ vars.AI_REVIEW_MODEL || 'claude-sonnet-4-5-20250929' }}" \
              --max-turns 10 \
              --allowedTools "Read,Glob,Grep,Bash(git log:*),Bash(git show:*),Bash(git diff:*)" \
            > /tmp/result.json
      - name: Upload result
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: review-${{ matrix.agent.key }}
          path: /tmp/result.json

  orchestrate-review:
    needs: [check-trigger, review-agent]
    if: always()
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version-file: '.node-version'
      - name: Download all artifacts
        continue-on-error: true
        uses: actions/download-artifact@v6
        with:
          path: /tmp/artifacts
          pattern: review-*
      - name: Generate Review Hero token
        id: review-hero-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.REVIEW_HERO_APP_ID }}
          private-key: ${{ secrets.REVIEW_HERO_PRIVATE_KEY }}
      - name: Run Review Hero orchestrator
        env:
          GITHUB_TOKEN: ${{ steps.review-hero-token.outputs.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ needs.check-trigger.outputs.pr_number }}
          ARTIFACTS_DIR: /tmp/artifacts
        run: node .github/scripts/ai-review/orchestrate.mjs
