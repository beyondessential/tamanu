name: Review Hero

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ai-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  check-trigger:
    runs-on: ubuntu-slim
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - id: check
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request?.body;
            const match = body?.match(/\[(?<checked>[ x])\]\s+\*\*Run Review Hero\*\* <!-- #ai-review -->/);
            core.setOutput('should_run', match?.groups.checked === 'x');

  review-agent:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        agent:
          - key: bugs
            prompt: bugs.md
          - key: performance
            prompt: performance.md
          - key: design
            prompt: design.md
          - key: bes
            prompt: bes-requirements.md
          - key: security
            prompt: security.md
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - uses: actions/setup-node@v6
        with:
          node-version-file: '.node-version'
      - name: Install Claude CLI
        run: npm install -g @anthropic-ai/claude-code
      - name: Get PR diff
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr diff ${{ github.event.pull_request.number }} > /tmp/pr.diff
      - name: Run ${{ matrix.agent.key }} agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          cat .github/scripts/ai-review/agent-prompt.md \
              .github/scripts/ai-review/prompts/${{ matrix.agent.prompt }} \
              <(echo -e "\n\n## PR Title\n\n$PR_TITLE\n\n## PR Diff\n\n\`\`\`diff") \
              /tmp/pr.diff \
              <(echo '```') \
            | claude -p \
              --output-format json \
              --model "${{ vars.AI_REVIEW_MODEL || 'claude-sonnet-4-5-20250929' }}" \
              --max-turns 10 \
              --allowedTools "Read,Glob,Grep,Bash(git log:*),Bash(git show:*),Bash(git diff:*)" \
            > /tmp/result.json
      - name: Upload result
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: review-${{ matrix.agent.key }}
          path: /tmp/result.json

  orchestrate-review:
    needs: [check-trigger, review-agent]
    if: always() && needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version-file: '.node-version'
      - name: Download all artifacts
        continue-on-error: true
        uses: actions/download-artifact@v6
        with:
          path: /tmp/artifacts
          pattern: review-*
      - name: Generate Review Hero token
        id: review-hero-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.REVIEW_HERO_APP_ID }}
          private-key: ${{ secrets.REVIEW_HERO_PRIVATE_KEY }}
      - name: Run Review Hero orchestrator
        env:
          GITHUB_TOKEN: ${{ steps.review-hero-token.outputs.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          ARTIFACTS_DIR: /tmp/artifacts
        run: node .github/scripts/ai-review/orchestrate.mjs
