name: Container image

on:
  workflow_call:
    inputs:
      ref:
        description: Ref to checkout and build
        type: string
        required: false
        default: ${{ github.ref }}
      package-name:
        description: Name of the package to build
        type: string
        required: true
      package-path:
        description: Path to the package to build
        type: string
        required: true
      cache-key:
        description: Docker build cache key (per package)
        type: string
        required: false
        default: ${{ github.ref }} # note this is not necessarily the checked out ref
      image-shatag:
        description: Apply shatag to the image.
        type: boolean
        required: false
        default: true
      image-tags:
        description: List of tags to apply to the image.
        type: string
        required: false
      image-labels:
        description: List of labels to apply to the image.
        type: string
        required: false
    outputs:
      tag:
        description: Tag(s) of the built image
        value: ${{ jobs.build.outputs.tag }}

permissions:
  contents: read
  id-token: write #Â OIDC token for AWS

jobs:
  build:
    name: Build ${{ github.event.inputs.package-name }}
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: ap-southeast-2
          role-to-assume: arn:aws:iam::143295493206:role/gha-build
          role-session-name: GithubActionsTamanuBuild

      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.ref }}

      - name: Setup buildkit
        uses: docker/setup-buildx-action@v2

      - name: Compute sha tag
        if: github.event.inputs.image-shatag
        uses: actions/github-script@v6
        id: shatag
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          INPUT_PACKAGE_NAME: ${{ github.event.inputs.package-name }}
        with:
          result-encoding: string
          script: |
            const { ECR_REGISTRY, INPUT_PACKAGE_NAME } = process.env;
            const sha = require('child_process').execSync('git log -n1 --format=%H').toString().trim();
            const name = `${ECR_REGISTRY}/tamanu/${INPUT_PACKAGE_NAME}`;
            return `${name}:sha-${sha}`;

      - name: Compute tags
        uses: actions/github-script@v6
        id: tags
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          INPUT_PACKAGE_NAME: ${{ github.event.inputs.package-name }}
          INPUT_TAGS: ${{ github.event.inputs.image-tags }}
        with:
          result-encoding: string
          script: |
            const { ECR_REGISTRY, INPUT_PACKAGE_NAME, INPUT_TAGS, GITHUB_ENV } = process.env;
            const name = `${ECR_REGISTRY}/tamanu/${INPUT_PACKAGE_NAME}`;
            return (INPUT_TAGS?.split(/\r?\n/) ?? []).map(tag => `${name}:${tag}`).join('\n');

      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          cache-from: type=gha,scope=${{ github.event.inputs.cache-key }}-${{ github.event.inputs.package-name }}
          cache-to: type=gha,mode=max,scope=${{ github.event.inputs.cache-key }}-${{ github.event.inputs.package-name }}
          build-args: PACKAGE_PATH=${{ github.event.inputs.package-path }}
          target: server
          push: true
          labels: |
            org.opencontainers.image.vendor=BES
            org.opencontainers.image.title=Tamanu ${{ github.event.inputs.package-name }}
            org.opencontainers.image.url=https://www.bes.au/products/tamanu/
            org.opencontainers.image.source=https://github.com/beyondessential/tamanu/
            org.opencontainers.image.revision=${{ github.sha }}
            ${{ github.event.inputs.image-labels }}
          tags: |
            ${{ steps.shatag.outputs.result }}
            ${{ steps.tags.outputs.result }}
    outputs:
      tag: ${{ steps.shatag.outputs.result || steps.tags.outputs.result }}
