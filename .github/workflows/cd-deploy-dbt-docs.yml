name: CD DBT docs

on:
  push:
    tags: ['v*.*.*']
    branches:
      - main
      - release/*

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write # to update the release notes
  id-token: write # OIDC token for AWS

jobs:
  config:
    name: Build and deploy docs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # TODO do we need TAMANU_RELEASE_PAT for this?
         ref: ${{ github.head_ref || github.ref }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install dbt-core dbt-postgres

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: npm

      - uses: actions/cache/restore@v3
        with:
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
          path: ${{ env.NODE_MODULES_PATHS }}

      - run: npm ci

      - name: Generate DBT docs
        run: npm run dbt-generate-docs

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-southeast-2
          role-to-assume: arn:aws:iam::491618206332:role/gha-dbt-docs-tamanu
          role-session-name: GHA@Tamanu=DBT

      - shell: bash
        run: echo "BRANCH_NAME=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV


      # TODO: do we use a matrix on this section here to be more dry
      # I had a go but it meant using artifacts to carry the docs between steps
      - name: Upload facility-server docs to S3
        run: |
          aws s3 sync database/docs/facility-server/target s3://bes-tamanu-dbt-docs/${{ env.BRANCH_NAME }}/facility-server/ \
            --delete \
            --cache-control "max-age=3600" \
            --exclude "*" \
            --include "catalog.json" \
            --include "index.html" \
            --include "manifest.json"

      - name: Upload central docs to S3
        run: |
          aws s3 sync database/docs/central/target s3://bes-tamanu-dbt-docs/${{ env.BRANCH_NAME }}/central/ \
            --delete \
            --cache-control "max-age=3600" \
            --exclude "*" \
            --include "catalog.json" \
            --include "index.html" \
            --include "manifest.json"

      - name: Update GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          append_body: true
          # TODO: use proper url
          body: |
            ## DBT Documentation
            The DBT documentation for this release is available at:
            - [Facility Server DBT Docs](https://example.com/dbt-docs/${{ github.ref_name }}/facility-server/)
            - [Central DBT Docs](https://example.com/dbt-docs/${{ github.ref_name }}/central/)

