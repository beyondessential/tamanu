name: CD Down

on:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  id-token: write #Â OIDC token for AWS

jobs:
  down:
    name: Bring down environment
    runs-on: ubuntu-latest
    steps:
      - id: setup
        uses: ./.github/actions/setup-cd
        with:
          ops-ssh-key: ${{ secrets.TAMANU_OPS_SSH }}
          tailscale-oauth: ${{ secrets.TAILSCALE_DBPROXY_ACCESS_OAUTH }}
          k8s-core: tamanu-internal-main

      - name: Down!
        uses: pulumi/actions@v5
        with:
          work-dir: ops/pulumi/stacks/tamanu/on-k8s
          command: destroy
          remove: true
          stack-name: bes/${{ steps.setup.outputs.stack-name }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-on-pr: false
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
