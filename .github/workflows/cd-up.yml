name: CD

on:
  workflow_dispatch:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
      - labeled
  push:
    branches:
      - main
      - release/*

concurrency:
  # only one build or destroy at a time, per PR/branch, but don't cancel existing runs
  group: cd-${{ github.pull_request.id || github.ref }}

permissions:
  contents: read
  pull-requests: write
  id-token: write #Â OIDC token for AWS

jobs:
  info:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.draft == false && contains(github.event.pull_request.labels.*.name, 'auto-deploy'))
    name: Branch info
    runs-on: ubuntu-latest
    steps:
      - name: Normalise branch/ref name
        uses: actions/github-script@v6
        id: ref
        env:
          GH_HEAD_REF: ${{ github.head_ref }}
          GH_REF_NAME: ${{ github.ref_name }}
        with:
          result-encoding: string
          script: |
            return ((process.env.GH_HEAD_REF || process.env.GH_REF_NAME)
              .toLowerCase()
              .replace(/[^a-z0-9-]/g, '-')
              .replace(/-+/g, '-')
              .replace(/^-|-$/g, ''));
    outputs:
      branch: ${{ steps.ref.outputs.result }}

  build:
    needs: info
    strategy:
      fail-fast: false
      matrix:
        platform:
          - arch: linux/amd64
            runs-on: ubuntu-latest
          # - arch: linux/arm64
          #   runs-on: ubuntu-arm64 # when available
        package:
          - name: central
            path: sync-server
          - name: facility
            path: lan
          # - name: meta
          #   path: meta-server
          # not yet used

    name: Build ${{ matrix.package.name }} container for ${{ matrix.platform.arch }}
    runs-on: ${{ matrix.platform.runs-on }}

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: ap-southeast-2
          role-to-assume: arn:aws:iam::143295493206:role/gha-build
          role-session-name: GithubActionsTamanuBuild

      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - uses: actions/checkout@v3
        with:
          # in PRs, use the actual PR branch, not the merge branch
          ref: ${{ github.event.pull_request.head.ref || github.ref }}

      - name: Install QEMU
        if: matrix.platform.arch == 'linux/arm64'
        uses: docker/setup-qemu-action@v2
      - name: Setup buildkit
        uses: docker/setup-buildx-action@v2

      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          platforms: ${{ matrix.platform.arch }}
          cache-from: type=gha,scope=${{ needs.info.outputs.branch }}-${{ matrix.package.name }}
          cache-to: type=gha,mode=max,scope=${{ needs.info.outputs.branch }}-${{ matrix.package.name }}
          build-args: PACKAGE_PATH=${{ matrix.package.path }}
          push: true
          labels: |
            org.opencontainers.image.vendor=BES
            org.opencontainers.image.title=Tamanu ${{ matrix.package.name }}
            org.opencontainers.image.url=https://www.bes.au/products/tamanu/
            org.opencontainers.image.source=https://github.com/beyondessential/tamanu/
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.pull_request.merged_at || github.event.head_commit.timestamp }}
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/tamanu/${{ matrix.package.name }}:sha-${{ github.sha }}
            ${{ steps.login-ecr.outputs.registry }}/tamanu/${{ matrix.package.name }}:${{ needs.info.outputs.branch }}
    outputs:
      tag: "sha-${{ github.sha }}"

  deploy:
    needs:
      - info
      - build
    runs-on: ubuntu-latest
    name: Deploy
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: ap-southeast-2
          role-to-assume: arn:aws:iam::143295493206:role/gha-deploy
          role-session-name: GithubActionsTamanuDeploy

      - name: Checkout this PR
        uses: actions/checkout@v3

      - name: Checkout ops
        uses: actions/checkout@v3
        with:
          repository: beyondessential/ops
          ssh-key: ${{ secrets.TAMANU_OPS_SSH }}
          path: ops

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: npm

      - name: Prepare pulumi
        run: npm ci
        working-directory: ops/pulumi

      - name: Prepare database credentials
        uses: aws-actions/aws-secretsmanager-get-secrets@v1
        with:
          parse-json-secrets: true
          secret-ids: "INTERNAL_DB, ${{ vars.INTERNAL_DB_SECRET_ARN }}"

      - name: Connect to Tailscale
        uses: ./.github/actions/tailscale
        with:
          oauth-secret: ${{ secrets.TAILSCALE_DBPROXY_ACCESS_OAUTH }}
          tags: tag:infra-gha-deploy

      # a constant secret + a variable plain text, hashed, = a new secret!
      # importantly this needs to remain constant for the lifetime of the stack
      - name: Prepare salt
        id: salt
        env:
          KEY: ${{ secrets.TAMANU_OPS_SSH }}
          NAME: ${{ needs.info.outputs.branch }}
        run: |
          salt=$(sha1sum <<< "$KEY$NAME" | cut -d' ' -f1)
          echo "::add-mask::$salt"
          echo "salt=$salt" >> $GITHUB_OUTPUT

      - name: Up!
        uses: pulumi/actions@v3
        with:
          work-dir: ops/pulumi/tamanu-internal
          command: up
          stack-name: bes/${{ needs.info.outputs.branch }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-on-pr: ${{ github.event_name == 'pull_request' }}
          upsert: true
          config-map: "{
            tamanu-internal:imageTag: {value: '${{ needs.build.outputs.tag }}', secret: false},
            tamanu-internal:salt: {value: '${{ steps.salt.outputs.salt }}', secret: true},
            postgresql:host: {value: '${{ vars.INTERNAL_DB_HOST }}', secret: false},
            postgresql:username: {value: '${{ env.INTERNAL_DB_USERNAME }}', secret: false},
            postgresql:password: {value: '${{ env.INTERNAL_DB_PASSWORD }}', secret: true},
            postgresql:superuser: {value: false, secret: false}, # required for RDS
          }"
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

  client:
    needs: info
    # because wine doesn't install on ubuntu
    # and yarn doesn't work on windows (io latency)
    runs-on: macos-latest
    name: Build desktop client
    steps:
      - name: Install wine
        # see https://github.com/actions/runner-images/issues/743
        run: brew install wine-stable

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: ap-southeast-2
          role-to-assume: arn:aws:iam::143295493206:role/gha-desktop-s3
          role-session-name: GithubActionsTamanuS3

      - uses: actions/checkout@v3

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: yarn

      - name: Install Python 3.10 (for node-gyp)
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Prepare yarn
        run: yarn && yarn build-shared
        env:
          PYTHON: /opt/homebrew/bin/python3.10

      - name: Build desktop client
        working-directory: packages/desktop
        run: yarn package-win

      - name: Pack desktop client
        working-directory: packages/desktop/release
        run: zip -q -r ../tamanu-$(jq .version ../package.json -r)-${{ github.sha }}.zip .

      - name: Upload as artifact
        uses: actions/upload-artifact@v3
        with:
          name: tamanu-desktop
          path: packages/desktop/tamanu-*.zip
          retention-days: 14

      - name: Push to S3
        working-directory: packages/desktop
        run: aws s3 cp tamanu-*.zip s3://${{ vars.DESKTOP_S3_BUCKET }}/${{ needs.info.outputs.branch }} --no-progress
