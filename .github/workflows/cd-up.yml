name: CD Up

on:
  workflow_call:
    secrets:
      PULUMI_ACCESS_TOKEN:
        required: true
      TAILSCALE_DBPROXY_ACCESS_OAUTH:
        required: true
      TAMANU_OPS_SSH:
        required: true

permissions:
  contents: read
  pull-requests: write
  id-token: write #Â OIDC token for AWS

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    env:
      K8S_CORE: tamanu-internal-main
    steps:
      - uses: actions/checkout@v4
      - id: setup
        uses: ./.github/actions/setup-cd
        with:
          ops-ssh-key: ${{ secrets.TAMANU_OPS_SSH }}
          tailscale-oauth: ${{ secrets.TAILSCALE_DBPROXY_ACCESS_OAUTH }}
          k8s-core: tamanu-internal-main

      - name: Create or check namespace
        run: |
          if kubectl get namespace tamanu-${{ steps.setup.outputs.stack-name }} 2>/dev/null; then
            echo "Namespace exists, checking it's matched to this branch"
            kubectl -n tamanu-${{ steps.setup.outputs.stack-name }} \
              get configmap auto-deploy -o json \
              | tee -a /dev/stderr \
              | jq -e '.data | [.repo == "${{ github.repository }}", .ref == "${{ github.ref }}"] | all'
          else
            kubectl create namespace tamanu-${{ steps.setup.outputs.stack-name }}
            kubectl -n tamanu-${{ steps.setup.outputs.stack-name }} \
              create configmap auto-deploy \
              --from-literal=repo=${{ github.repository }} \
              --from-literal=ref=${{ github.ref }}
          fi

      - name: Up!
        uses: pulumi/actions@v5
        with:
          work-dir: ops/pulumi/stacks/tamanu/on-k8s
          command: up
          stack-name: bes/${{ steps.setup.outputs.stack-name }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-on-pr: false
          upsert: true
          config-map: >
            {
            tamanu-on-k8s:namespace: {value: 'tamanu-${{ steps.setup.outputs.stack-name }}', secret: false},
            tamanu-on-k8s:imageTag: {value: 'sha-${{ github.sha }}', secret: false},
            tamanu-on-k8s:k8s-core: {value: 'bes/k8s-core/${{ steps.setup.outputs.k8s-core }}', secret: false},
            tamanu-on-k8s:architecture: {value: 'arm64', secret: false},
            }
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
