name: CD Setup
description: Set up Pulumi, Tailscale, and K8S
inputs:
  ops-ssh-key:
    description: SSH key for ops repo
    required: false
  ops-ref:
    description: Ref to checkout in ops repo
    default: main
  tailscale-oauth-client-id:
    description: Tailscale OAuth client ID for OIDC authentication
    required: true
  tailscale-tags:
    description: Tailscale tags for the connection (must match OIDC trust configuration)
    required: true
  tailscale-k8s-operator-hostname:
    description: Hostname of the Tailscale Kubernetes operator to configure kubeconfig
    required: true
runs:
  using: composite
  steps:
    - if: inputs.ops-ssh-key
      name: Checkout ops
      uses: actions/checkout@v6
      with:
        repository: beyondessential/ops
        ssh-key: ${{ inputs.ops-ssh-key }}
        path: ops
        ref: ${{ inputs.ops-ref }}
    - name: Remove ops/.git so pulumi doesn't get confused
      if: inputs.ops-ssh-key
      shell: bash
      run: rm -rf ops/.git

    - name: Install Node.js for ops
      if: inputs.ops-ssh-key
      uses: actions/setup-node@v6
      with:
        node-version-file: ops/.node-version
        cache: npm

    - name: Install Node.js for us
      if: '!inputs.ops-ssh-key'
      uses: actions/setup-node@v6
      with:
        node-version-file: .node-version
        cache: npm

    - name: Prepare pulumi
      if: inputs.ops-ssh-key
      shell: bash
      working-directory: ops/pulumi
      run: npm ci

    - name: Pre-install pulumi
      if: inputs.ops-ssh-key
      uses: pulumi/actions@v5

    - name: Connect to Tailscale
      uses: tailscale/github-action@v4
      with:
        oauth-client-id: ${{ inputs.tailscale-oauth-client-id }}
        audience: api.tailscale.com/${{ inputs.tailscale-oauth-client-id }}
        tags: '${{ inputs.tailscale-tags }}'

    - name: Configure kubeconfig
      shell: bash
      run: |
        sudo tailscale set --operator=$USER
        tailscale configure kubeconfig ${{ inputs.tailscale-k8s-operator-hostname }}

    - name: Test kubernetes cluster for readiness
      shell: bash
      run: kubectl get namespace/tamanu-system
